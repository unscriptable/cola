<!DOCTYPE html>
<html>
<head>
<title>Demo using Object.observe(array)</title>

<script src="bower_components/curl/src/curl.js"></script>

<script>
curl.config(
	{
		baseUrl: '',
		packages: {
			curl: { location: 'bower_components/curl/src/curl' },
			cola: { location: '../../' },
			meld: { location: 'bower_components/meld', main: 'meld' },
			when: { location: 'bower_components/when', main: 'when' }
		}
	}
);

curl(
['cola/view/Collection', 'cola/view/Model', 'cola/view/observe/atForms', 'cola/view/bind/byAttr', 'cola/view/bind/bySelectorMap', 'cola/data/metadata/ObjectMetadata'],
function (Collection, Model, observeAtForms, bindByAttr, bindBySelectorMap, ObjectMetadata) {
	var root, form, collectionView, formView, coders;

	root = document.getElementById('list');
	form = document.getElementById('edit');

	collectionView = Collection(root, {
		binder: bindByAttr({}),
		sortBy: 'lastname'
	});
	formView = Model(form, {
		binder: bindBySelectorMap({
			bindings: {
				firstname: '.firstname',
				lastname: '.lastname',
				superpower: '.superpower'
			}
		})
	});
	formView = observeAtForms(formView, {
		// simple on() implementation
		on: function (node, event, listener, query) {
//			node.addEventListener(event, ifMatches, false);
//			return function () {
//				node.removeEventListener(event, ifMatches, false);
//			};
//			function ifMatches (e) {
//				var matches, el, i;
//				matches = query ? [].slice.apply(node.querySelectorAll(query)) : [node];
//				while (el = matches.pop()) if (el == node) return listener(e);
//			}
		}
	});
	collectionView.set([], new ObjectMetadata('spid'));

	coders = [];
	Object.observe(coders, collectionView.update);

	coders.push({
		spid: 1,
		firstname: 'Brian',
		lastname: 'Cavalier'
	});
	coders.push({
		spid: 2,
		firstname: 'John',
		lastname: 'Hann'
	});

	setTimeout(function () {
		coders[0] = {
			spid: coders[0].spid,
			firstname: coders[0].firstname,
			lastname: coders[0].lastname,
			superpower: 'Can has mind meld with the codez.'
		};
		coders[1] = {
			spid: coders[1].spid,
			firstname: coders[1].firstname,
			lastname: coders[1].lastname,
			superpower: 'Able to cram tall bundles in a single build.'
		};
		coders.push({
			spid: 3,
			firstname: 'Scott',
			lastname: 'Andrews',
			superpower: 'Can rest just about anywhere.'
		});
		coders.push({
			spid: 4,
			firstname: 'Jeremy',
			lastname: 'Grelle',
			superpower: 'Able to be coherent at 7 AM during standups.'
		});
	}, 2000);

	document.body.addEventListener('click', function (e) {
		if (e.target.nodeName != 'BUTTON') return;
		e.preventDefault();
		var coder = collectionView.find(e);
		if (coder) {
			// how do we observe real-time changes?
			formView.set(coder);
		}
	}, false);

	formView.observe(function (updated) {
		if (updated) {
			// this is unfortunately lame:
			coders.some(function (coder, i) {
				if (coder.spid == updated.spid) {
					coders[i] = clone(updated);
					return true;
				}
			});
			formView.clear();
		}
	});

	form.addEventListener('reset', function (e) {
		formView.clear();
	}, false);

	function clone (obj) {
		var o = {};
		for (var p in obj) {
			if (obj.hasOwnProperty(p)) o[p] = obj[p];
		}
		return o;
	}

});
</script>

</head>
<body>

<h2>Super coders</h2>

<ul id="list" data-cola-section="person">
	<li>
		<h3>
			<span data-cola-bind="text:lastname"></span>,
			<span data-cola-bind="text:firstname"></span>
		</h3>
		<i><span data-cola-bind="text:superpower"></span></i>
		<button type="button">Edit</button>
	</li>
</ul>

<p>(click to edit)</p>
<hr/>
<form method="post" action="#" id="edit" data-cola-section="person">
	<h3>
		Super coder: <input class="firstname" data-cola-bind="value:lastname"/>
		<input class="lastname" data-cola-bind="value:firstname"/>
	</h3>
	<label>
		Super power:
		<textarea class="superpower" data-cola-bind="value:superpower" cols="80"></textarea>
	</label>
	<br/>
	<button type="submit">Save</button>
	<button type="reset">Clear</button>
</form>

<style>
	ul { padding: 0; background-color: #eee; }
	li { list-style: none; }
	li:hover { background-color: #efe; }
</style>
</body>
</html>
